{
  "name": "Workflow Processamento - Gold",
  "nodes": [
    {
      "parameters": {
        "jsCode": "// Loop por cada item que veio do Banco de Dados\nreturn items.map(item => {\n  // Pegamos o JSON original que estava salvo na coluna raw_data\n  const raw = item.json.raw_data;\n\n  // 1. Cálculos de Datas\n  const criacao = new Date(raw.created_at);\n  const atualizacao = new Date(raw.updated_at);\n  // Diferença em minutos\n  const duracaoMinutos = Math.round((atualizacao - criacao) / 60000);\n\n  // 2. Cálculo de Tempo por Contato\n  let tempoPorContato = 0;\n  if (raw.total_contacts > 0) {\n    tempoPorContato = duracaoMinutos / raw.total_contacts;\n  }\n\n  // 3. Categoria de Tamanho (Regra de Negócio)\n  let categoria = 'PEQUENO';\n  if (raw.total_contacts > 1000) categoria = 'MUITO_GRANDE';\n  else if (raw.total_contacts > 500) categoria = 'GRANDE';\n  else if (raw.total_contacts >= 100) categoria = 'MEDIO';\n\n  // 4. Traduções\n  const statusMap = {\n    'COMPLETED': 'CONCLUIDO',\n    'PROCESSING': 'EM_PROCESSAMENTO',\n    'FAILED': 'FALHOU',\n    'CANCELED': 'CANCELADO'\n  };\n  \n  const tipoMap = {\n    'COMPANY': 'EMPRESA',\n    'PERSON': 'PESSOA'\n  };\n\n  // 5. Montamos o Objeto final da Tabela GOLD\n  return {\n    json: {\n      id_enriquecimento: raw.id,\n      id_workspace: raw.id_workspace,\n      nome_workspace: raw.workspace_name,\n      total_contatos: raw.total_contacts,\n      tipo_contato: tipoMap[raw.contact_type] || raw.contact_type,\n      status_processamento: statusMap[raw.status] || raw.status,\n      data_criacao: raw.created_at,\n      data_atualizacao: raw.updated_at,\n      \n      // Campos Calculados\n      duracao_processamento_minutos: duracaoMinutos,\n      tempo_por_contato_minutos: tempoPorContato,\n      processamento_sucesso: raw.status === 'COMPLETED',\n      categoria_tamanho_job: categoria,\n      necessita_reprocessamento: ['FAILED', 'CANCELED'].includes(raw.status),\n      \n      // Carimbo de hora atual\n      data_atualizacao_dw: new Date().toISOString()\n    }\n  };\n});"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        0,
        0
      ],
      "id": "874e46f1-3793-42af-a302-55ce1882eb3d",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "operation": "upsert",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "gold_enrichments",
          "mode": "list",
          "cachedResultName": "gold_enrichments"
        },
        "columns": {
          "mappingMode": "autoMapInputData",
          "value": {
            "processamento_sucesso": false,
            "necessita_reprocessamento": false,
            "total_contatos": 0,
            "duracao_processamento_minutos": 0,
            "tempo_por_contato_minutos": 0
          },
          "matchingColumns": [
            "id_enriquecimento"
          ],
          "schema": [
            {
              "id": "id_enriquecimento",
              "displayName": "id_enriquecimento",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "id_workspace",
              "displayName": "id_workspace",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "nome_workspace",
              "displayName": "nome_workspace",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "total_contatos",
              "displayName": "total_contatos",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": false
            },
            {
              "id": "tipo_contato",
              "displayName": "tipo_contato",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "status_processamento",
              "displayName": "status_processamento",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "data_criacao",
              "displayName": "data_criacao",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": false
            },
            {
              "id": "data_atualizacao",
              "displayName": "data_atualizacao",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": false
            },
            {
              "id": "duracao_processamento_minutos",
              "displayName": "duracao_processamento_minutos",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": false
            },
            {
              "id": "tempo_por_contato_minutos",
              "displayName": "tempo_por_contato_minutos",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": false
            },
            {
              "id": "processamento_sucesso",
              "displayName": "processamento_sucesso",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": false
            },
            {
              "id": "categoria_tamanho_job",
              "displayName": "categoria_tamanho_job",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "necessita_reprocessamento",
              "displayName": "necessita_reprocessamento",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": false
            },
            {
              "id": "data_atualizacao_dw",
              "displayName": "data_atualizacao_dw",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        208,
        0
      ],
      "id": "13d4e4e1-a621-48a1-a3de-9d92b50faa55",
      "name": "Insert or update rows in a table1",
      "credentials": {
        "postgres": {
          "id": "mq0CV2VySgH4cUCb",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "inputSource": "passthrough"
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        -224,
        0
      ],
      "id": "3213fc6e-1798-484d-9aea-8184de7e562b",
      "name": "When Executed by Another Workflow"
    }
  ],
  "pinData": {},
  "connections": {
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "Insert or update rows in a table1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "When Executed by Another Workflow": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false
  },
  "versionId": "5d104b4b-77e6-4e53-9bd1-29679d32a6fc",
  "meta": {
    "instanceId": "b9e998059bea9beb6a0df031d9e07d648a2c64904f1deb0ef635f24f3d4ee8e4"
  },
  "id": "tRGtGz2O_M83xwe-m1-rC",
  "tags": []
}